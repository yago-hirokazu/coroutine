
# (1) trampoline.S
```
    .text
    .global trampoline
    # .type trampoline, @function
trampoline:
    movq %rdi, %rax # rax <= fn
    movq %rdx, %rsp # rsp <= stack_top (change another stack)

    pushq $0        # dummy for ret (push 0 due to no place to return)
    movq %rsi, %rdi # rdi <= arg
    call *%rax      # fn(arg)

    call exit
```


# (2) main.c
```
#include <stdio.h>
#include <stdint.h>

extern void trampoline(void (*fn)(void *), void *arg, void *stack_top);

void worker(void *arg)
{
        const char *msg = arg;
        for (int i=0; i<3; i++) {
                printf("worker: %s (%d)\n", msg, i);
        }

        // trampoline cannot return to caller, so exit
        printf("worker done, exiting...\n");
        fflush(stdout);
        _Exit(0);
}

int main(int argc, char *argv[])
{
        static uint8_t stack[64 * 1024];
        void *stack_top = stack + sizeof(stack);

        printf("main: start trampoline...\n");
        printf("worker = %p\n", (void *)worker);
        printf("stack_top = %p\n", stack_top);
        trampoline(worker, "hello", stack_top);

        // trampoline cannot return to caller, so it never come here
        printf("main: done\n");
        return 0;
}
```

# (3) msys2 console
```
 # Host: TKYCWL1722 | User: yagouhir | Time: 2025-09-12 13:28:57
 # Path: /c/usr/project/context_switch/mingw64/trial1
 # # gcc -g -O0 -fno-omit-frame-pointer -ggdb main.c trampoline.S -o a.exe

 âœ” Success (retv = 0)

 # Host: TKYCWL1722 | User: yagouhir | Time: 2025-09-12 13:29:23
 # Path: /c/usr/project/context_switch/mingw64/trial1
 # # gdb --args ./a.exe
GNU gdb (GDB) 16.3
Copyright (C) 2024 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "x86_64-w64-mingw32".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<https://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
    <http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from ./a.exe...
(gdb) run
Starting program: C:\usr\project\context_switch\mingw64\trial1\a.exe
[New Thread 7980.0x3f0c]
main: start trampoline...
worker = 00007ff75cf01450
stack_top = 00007ff75cf1e040

Thread 1 received signal SIGSEGV, Segmentation fault.
trampoline () at trampoline.S:14
14          pushq $0        # dummy for ret (push 0 due to no place to return)
(gdb) bt full
#0  trampoline () at trampoline.S:14
No locals.
#1  0x616d006f6c6c6568 in ?? ()
No symbol table info available.
#2  0x656e6f64203a6e69 in ?? ()
No symbol table info available.
#3  0x0000000000000000 in ?? ()
No symbol table info available.
(gdb)  info registers
rax            0x33                51
rbx            0x7ff75cf1e050      140700393005136
rcx            0x7ff75cf01450      140700392887376
rdx            0x7ff75cf0a060      140700392923232
rsi            0x1                 1
rdi            0x33                51
rbp            0x5ffe50            0x5ffe50
rsp            0x7ff75cf0a060      0x7ff75cf0a060
r8             0x7ff75cf1e040      140700393005120
r9             0x0                 0
r10            0x0                 0
r11            0x246               582
r12            0x1                 1
r13            0x6979d0            6912464
r14            0x0                 0
r15            0x697950            6912336
rip            0x7ff75cf01556      0x7ff75cf01556 <trampoline+6>
eflags         0x10202             [ IF RF ]
cs             0x33                51
ss             0x2b                43
ds             0x2b                43
es             0x2b                43
fs             0x53                83
gs             0x2b                43
(gdb) disassemble
Dump of assembler code for function trampoline:
   0x00007ff75cf01550 <+0>:     mov    %rdi,%rax
   0x00007ff75cf01553 <+3>:     mov    %rdx,%rsp
=> 0x00007ff75cf01556 <+6>:     push   $0x0
   0x00007ff75cf01558 <+8>:     mov    %rsi,%rdi
   0x00007ff75cf0155b <+11>:    call   *%rax
   0x00007ff75cf0155d <+13>:    call   0x7ff75cf08678 <exit>
   0x00007ff75cf01562 <+18>:    nop
   0x00007ff75cf01563 <+19>:    nop
   0x00007ff75cf01564 <+20>:    nop
   0x00007ff75cf01565 <+21>:    nop
   0x00007ff75cf01566 <+22>:    nop
   0x00007ff75cf01567 <+23>:    nop
   0x00007ff75cf01568 <+24>:    nop
   0x00007ff75cf01569 <+25>:    nop
   0x00007ff75cf0156a <+26>:    nop
   0x00007ff75cf0156b <+27>:    nop
   0x00007ff75cf0156c <+28>:    nop
   0x00007ff75cf0156d <+29>:    nop
   0x00007ff75cf0156e <+30>:    nop
   0x00007ff75cf0156f <+31>:    nop
End of assembler dump.
(gdb) x/32gx $rsp
0x7ff75cf0a060: 0x616d006f6c6c6568      0x656e6f64203a6e69
0x7ff75cf0a070: 0x0000000000000000      0x0000000000000000
0x7ff75cf0a080 <__dyn_tls_init_callback>:       0x00007ff75cf01690      0x0000000000000000
0x7ff75cf0a090 <__dyn_tls_init_callback+16>:    0x0000000000000000      0x0000000000000000
0x7ff75cf0a0a0 <_tls_used>:     0x00007ff75cf20000      0x00007ff75cf20008
0x7ff75cf0a0b0 <_tls_used+16>:  0x00007ff75cf1e08c      0x00007ff75cf0b1d0
0x7ff75cf0a0c0 <_tls_used+32>:  0x0000000000000000      0x0000000000000000
0x7ff75cf0a0d0 <_tls_used+48>:  0x0000000000000000      0x0000000000000000
0x7ff75cf0a0e0 <_tls_used+64>:  0x746e656d75677241      0x206e69616d6f6420
0x7ff75cf0a0f0 <_tls_used+80>:  0x442820726f727265      0x4100294e49414d4f
0x7ff75cf0a100 <_tls_used+96>:  0x20746e656d756772      0x72616c75676e6973
0x7ff75cf0a110 <_tls_used+112>: 0x4749532820797469      0x000000000000294e
0x7ff75cf0a120 <_tls_used+128>: 0x776f6c667265764f      0x652065676e617220
0x7ff75cf0a130 <_tls_used+144>: 0x564f2820726f7272      0x0029574f4c465245
0x7ff75cf0a140 <_tls_used+160>: 0x206c616974726150      0x20666f2073736f6c
0x7ff75cf0a150 <_tls_used+176>: 0x636966696e676973      0x4c50282065636e61
(gdb)
```
